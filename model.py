#!/usr/bin/env python3

import sys
import math
import scipy.optimize as optimize

from libsimple import *

STEP_DAYS = 5
POPULATION = 10700000

numTests = [
  224,
  233.142857142857,
  246.142857142857,
  281.857142857143,
  329.857142857143,
  450.571428571429,
  319.571428571429,
  651.285714285714,
  1120.42857142857,
  1370.28571428571,
  1571.14285714286,
  1956.57142857143,
  3060,
  4577.85714285714,
  6583.85714285714,
  9532.85714285714,
  10967,
  10304.4285714286,
  9621.42857142857,
  6954.28571428571,
  4897,
  3982.28571428571,
  3471.71428571429,
  3115.42857142857,
  3437.85714285714,
  4202.57142857143,
  5086.71428571429,
  6165.71428571429,
  6981.19047619048,
  7796.66666666667,
  8612.71428571429,
  9894.28571428571,
  6717.14285714286,
  5892.42857142857,
  5448.42857142857,
  5514.28571428571,
  5670.85714285714,
  5889.42857142857,
  6196.42857142857,
  7347.14285714286]

numDeaths = [
  1,
  0.857142857142857,
  2,
  1.85714285714286,
  1.42857142857143,
  1.42857142857143,
  3.28571428571429,
  4.14285714285714,
  7.57142857142857,
  11.4285714285714,
  13.5714285714286,
  18.1428571428571,
  30.4285714285714,
  50.7142857142857,
  70.5714285714286,
  109,
  152.857142857143,
  202.571428571429,
  220.142857142857,
  196.142857142857,
  168.285714285714,
  138.857142857143,
  130.142857142857,
  116.714285714286,
  101.857142857143,
  95.4285714285714,
  108.857142857143,
  103.857142857143,
  108.285714285714,
  131.142857142857,
  149.714285714286,
  173.142857142857,
  166.428571428571,
  152,
  140.428571428571,
  134.428571428571,
  125.428571428571,
  125.571428571429,
  127.857142857143,
  136.571428571429]

positivePct = [
  0.042028571428572,
  0.043657142857143,
  0.046557142857143,
  0.051514285714286,
  0.053385714285714,
  0.061371428571429,
  0.042342218463053,
  0.064107489641527,
  0.085489139133488,
  0.091911083669238,
  0.110350728248422,
  0.142535710023905,
  0.204578946278166,
  0.263601114926831,
  0.286056664479535,
  0.331194788180347,
  0.346661362386889,
  0.335951285730807,
  0.334498440823721,
  0.285571315400476,
  0.262963925503292,
  0.240831109200859,
  0.223397878858131,
  0.210177917177275,
  0.230609434947927,
  0.23889207294996,
  0.254460343009059,
  0.26155243866426,
  0.293868521108122,
  0.326184603551985,
  0.358500685995847,
  0.32819268593574,
  0.260860824261698,
  0.264469829770282,
  0.252117596179293,
  0.252997099311011,
  0.254796827846791,
  0.261184502879664,
  0.26390630332043,
  0.280086218038802]

hospitalized = [
  109.142857142857,
  107.428571428571,
  108,
  117,
  139.142857142857,
  168.285714285714,
  209.571428571429,
  273.428571428571,
  387.571428571429,
  572.571428571429,
  771,
  1047.85714285714,
  1510.42857142857,
  2213.42857142857,
  3152.42857142857,
  4449.71428571429,
  5827.71428571429,
  7249.57142857143,
  7904.57142857143,
  7484.57142857143,
  6679.42857142857,
  6009.42857142857,
  5330.28571428572,
  4742.57142857143,
  4432.42857142857,
  4422.42857142857,
  4577.14285714286,
  4616,
  4532.85714285714,
  5476.28571428572,
  6536.42857142857,
  7196,
  7093.28571428572,
  6625.14285714286,
  6148.42857142857,
  5901.14285714286,
  5826.28571428571,
  5908.14285714286,
  5967.71428571429,
  6235.42857142857]

agTests = [
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0,
  0.02324151972648,
  0.028541296205214,
  0.034939387927704,
  0.038681960808042,
  0.042395640530359,
  0.04948778145342,
  0.07852581728312,
  0.086280327859605,
  0.072692877872585,
  0.054290713367438,
  0.049992600540161,
  0.046798674361202,
  0.04121543221814,
  0.041014972412112,
  0.041873366700625,
  0.041315776411903,
  0.043835557773375]

print(len(numTests), len(positivePct), len(hospitalized), len(numDeaths), len(agTests))

if len(sys.argv) > 1:
  idx = int(sys.argv[1])
  numTests = numTests[-idx:]
  numDeaths = numDeaths[-idx:]
  positivePct = positivePct[-idx:]
  hospitalized = hospitalized[-idx:]

params, paramRanges, scales = computeInitialParams(numTests, positivePct, hospitalized, numDeaths, POPULATION, STEP_DAYS, agTests)

runOptimization(params, paramRanges, scales, (numTests, positivePct, numDeaths, hospitalized, agTests), w = (1.0, 1.5, 1.0, .2, 2.0, 3.0))
